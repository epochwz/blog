# 高并发

## 基础知识

### 概览

![基础知识讲解与核心知识准备](/docs/images/notes/java/concurrency/基础知识讲解与核心知识准备.png)

![并发及并发安全的处理](/docs/images/notes/java/concurrency/并发及并发的线程安全处理.png)

![高并发处理的思路及手段](/docs/images/notes/java/concurrency/高并发处理的思路及手段.png)

![并发的优势和风险](/docs/images/notes/java/concurrency/并发的优势和风险.png)

### 并发、并行、高并发

- **并发**：如果多线程程序运行在单核处理器上，则多个线程需要交替占用 CPU 时间片来执行，从而实现 **看起来** 同时运行
- **并行**：如果多线程程序运行在多核处理器上，则多个线程(和核心数量相等)可以同时占用 CPU 并实现 **真正的** 同时运行
- **高并发**：互联网分布式系统架构设计中必须考虑的因素之一，通常是指 通过设计保证系统能够 **同时并行处理** 大量的请求

**侧重点不同**

- 并发：多个线程操作相同的资源，保证线程安全，合理使用资源
- 高并发：服务能够同时处理大量请求，提高程序性能

### 并发安全的由来

1. CPU **重排序** 优化 导致的 **乱序执行**：处理器为提高运行速度而做出违背代码原有顺序的优化
2. CPU 多级缓存造成的缓存不一致

**为什么需要 CPU Cache?**

CPU 和 Main Memory 的速度差距太大了，导致在 CPU 的时钟周期内，CPU 常常需要等待主存，导致浪费 CPU 资源，因此需要加入多级缓存来缓解两者速度不匹配的问题

**CPU Cache 有什么实际意义？**

- 问题描述：由于 CPU Cache 容量远远小于 Main Memory, 所以难免会出现缓存不命中的情况，那么 Cache 还有意义吗？
- 问题答案
  - 时间局部性：如果某个数据被访问，那么在不久的将来它很可能再次被访问
  - 空间局部性：如果某个数据被访问，那么与它相邻的数据也可能很快被访问

**缓存一致性协议 (MESI)**: 用于保证多个 CPU Cache 之间的共享数据的一致性

## Java 内存模型

为了屏蔽掉各种硬件和操作系统的内存访问差异，以实现让 Java 程序在各种平台下都能达到一致的并发效果，Java 虚拟机规范中定义了 Java 内存模型 (Java Memory Model,JMM)

JMM 是一种规范，规定了 JVM 如何与计算机内存协同工作，规定了一个线程如何以及何时可以看到其他线程修改过后的共享变量的值，以及在必须时如何同步的访问共享变量

JMM 8 种同步操作规则

## JUC

CountdownLatch 实现一个或多个线程需要等待其他线程完成某些操作之后才能继续往下执行

CyclicBarrier 实现多个线程之间相互等待，直到所有线程都满足条件之后才能继续往下执行