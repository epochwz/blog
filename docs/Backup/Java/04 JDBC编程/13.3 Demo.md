# 示例：完整的JDBC程序
使用配置文件保存Connection参数，实现程序更好的移植性,配置文件如下：

![数据库配置文件][]
```java
package org.jwz.test;

import java.sql.*;
import java.io.FileInputStream;
import java.io.IOException;
import java.util.Properties;

/**
 * JDBC程序完整示例
 */
public class JDBC_Demo {
    // 定义Connection的参数
    private String driver;// 数据库驱动
    private String url;// 指定数据库的链接
    private String user;// 数据库用户名
    private String pass;// 数据库密码

    /**
     * 构造器，初始化Connection的参数
     *
     * @param paramFile [数据库配置文件]
     */
    public JDBC_Demo(String paramFile) {
        try {
            // 使用Properties类来加载配置文件
            Properties props = new Properties();
            props.load(new FileInputStream(paramFile));

            // 获取配置文件的参数信息，初始化Connection的参数
            driver = props.getProperty("driver");
            url = props.getProperty("url");
            user = props.getProperty("user");
            pass = props.getProperty("pass");
        } catch (IOException e) {
            System.out.println("IO异常");
        }
    }

    // 程序通过JDBC访问数据库的步骤
    private void example(String sql) {
        try {
            // 1. 使用反射加载数据库驱动
            Class.forName(driver);
            try (
                    // 2. 使用DriverManager获取URL对应数据库的连接
                    Connection conn = DriverManager.getConnection(url, user, pass);
                    // 3. 创建Statement对象
                    Statement stmt = conn.createStatement()
            ) {
                // 4. 使用Statement执行SQL语句[执行查询时返回结果集]
                ResultSet rs = stmt.executeQuery(sql);
                // 5. 操作结果集
                while (rs.next()) {
                    System.out.println("id:"+rs.getString("id"));
                }
                // 6. try块自动回收数据库资源[ResultSet,Statement,Connection]
            }
        } catch (ClassNotFoundException e) {
            System.out.println("找不到数据库驱动程序");
        } catch (SQLException e) {
            System.out.println("数据库连接异常");
            e.printStackTrace();
        }
    }
    public static void main(String args[]){
        new JDBC_Demo("mysql.ini").example("select * from test_table");
    }
}
```

# 使用数据库连接池的完整示例
```java
package org.jwz.test;

// 导入数据源API
import com.mchange.v2.c3p0.ComboPooledDataSource;

import java.beans.PropertyVetoException;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.sql.Connection;
import java.sql.SQLException;
import java.util.Properties;

/**
 * 数据库连接池完整示例
 * Created by 龍惊羽 on 2017/4/3.
 */
public class ConnectionPool {
    // 定义数据库连接池类变量ds
    public static ComboPooledDataSource ds;

    // 类加载时初始化连接池
    static {
        try {
            // 创建连接池对象
            ds = new ComboPooledDataSource();

            // 创建Properties对象来加载数据库配置文件
            Properties p = new Properties();
            p.load(new FileInputStream("mysql.ini"));

            // 从配置文件获取参数信息并初始化数据库连接池的参数
            ds.setDriverClass(p.getProperty("driver"));
            ds.setJdbcUrl(p.getProperty("url"));
            ds.setUser(p.getProperty("user"));
            ds.setPassword(p.getProperty("pass"));

            // 初始化连接池详细信息
            ds.setInitialPoolSize(5);
            ds.setMaxPoolSize(20);
            ds.setMinPoolSize(3);
            ds.setMaxStatements(180);

        } catch (FileNotFoundException e) {
            System.out.println(e.getMessage());
        } catch (IOException e) {
            System.out.println(e.getMessage());
        } catch (PropertyVetoException e) {
            System.out.println(e.getMessage());
        }
    }
    
    // 测试通过连接池获取Connection
    public static void main(String args[]) {
        try (
            Connection conn = ds.getConnection();
        ) {
            System.out.println("数据库连接成功");
        } catch (SQLException e) {
            System.out.println(e.getMessage());
        }
    }
}
```

# 示例：防止SQL注入攻击
```
package org.jwz.test;

import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;

import static org.jwz.test.ConnectionPool.ds;

/**
 * SQL注入攻击
 * Created by 龍惊羽 on 2017/4/3.
 */
public class SqlAttact {
    // Statement实现登陆验证
    private static void stmtAttact(String user, String pass) {
        String sql = "select * from test_table where user='" + user + "' and pass='" + pass + "';";
        System.out.println(sql);
        try (
                Statement stmt = ds.getConnection().createStatement();
                ResultSet rs = stmt.executeQuery(sql);
        ) {
            if (rs.next()) {
                System.out.println("登陆成功");
            } else {
                System.out.println("登陆失败");
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }

    // PreparedStatement实现账号登陆验证
    private static void pstmtAttact(String user, String pass) {
        String sql = "select * from test_table where user=? and pass=?;";
        System.out.println(sql);
        try (
                // 1. 创建PreparedStatement对象，预编译SQL语句
                PreparedStatement pstmt = ds.getConnection().prepareStatement(sql)
        ) {
            // 2. 传参给预编译的SQL语句，若不清楚参数类型，使用setObject,由pstmt负责类型转换
            pstmt.setString(1, user);
            pstmt.setString(2, pass);
            // 3. 执行SQL语句获取结果集
            ResultSet rs = pstmt.executeQuery();
            if (rs.next()) {
                System.out.println("登陆成功");
            } else {
                System.out.println("登陆失败");
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }

    // 对两种实现方式分别进行SQL注入攻击
    public static void main(String[] args) {
        // 登陆成功，说明注入攻击成功
        stmtAttact("Jack", "' or true or'");
        // 登陆失败，说明注入攻击失败
        pstmtAttact("Jack", "' or true or'");
    }
}
```

# 示例：CallableStatement调用存储过程
1. 创建存储过程
    ```java
    delimiter @@
    create procedure add_pro(a int,b int,out sum int)
    begin
    set sum=a+b;
    end;
    @@
    ```
2. 调用存储过程
```java
package org.jwz.test;

import java.sql.CallableStatement;
import java.sql.SQLException;
import java.sql.Types;

import static org.jwz.test.ConnectionPool.ds;

/**
 * CallableStatement:调用存储过程
 * Created by 龍惊羽 on 2017/4/3.
 */
public class CallableStmt {
    public static void main(String[] args) {
        // 1. 定义SQL语句
        String sql="{call add_pro(?,?,?)}";
        try(
                // 2. 创建CallableStatement对象
                CallableStatement cstmt=ds.getConnection().prepareCall(sql)
        ){
            // 3. 传入存储过程的输入参数
            cstmt.setInt(1,2);
            cstmt.setInt(2,3);
            // 4. 注册存储过程的输出参数的类型
            cstmt.registerOutParameter(3, Types.INTEGER);
            // 5. 执行SQL语句
            cstmt.execute();
            // 6. 获取存储过程的输出参数
            System.out.println(cstmt.getInt(3));
        }catch (SQLException e) {
            System.out.println("数据库异常");
        }
    }
}

```

[数据库配置文件]:http://note.youdao.com/yws/public/resource/19cc8a2d6058bd78bb4dc157fb70ad26/xmlnote/336B4726E2314254A9AE85089A38EFBD/5853 "数据库配置文件"