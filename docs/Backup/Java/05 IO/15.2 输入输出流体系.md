# 15.2.1 流的概念模型
Java把不同的输入/输出源[键盘、文件、网络连接等]抽象表述为"流"，通过流的方式允许程序使用相同方式访问不同的输入/输出源

抽象模型:输入/输出流相当于水管，字节/字符相当于水管中的水滴，隐式指针记录当前准备读/写的位置,随着放入/取出，不断后移

![处理流的模型图]

处理流的优点:
- 性能的提高:以增加缓冲的方式来提高输入/输出的效率
- 操作的便捷:处理流可能提供一系列便捷方法来一次输入/输出大批量的内容，而不是一个或多个"水滴"
- 装饰器模式:程序无须理会输入/输出节点是磁盘、网络还是其他设备，只要将这些节点流包装成相同的处理流，就可以使用相同的输入/输出代码来读写不同物理存储节点的数据,而程序实际访问的数据源随着处理流包装的节点流的变化而变化

# 15.2.2 流的分类
1. 输入流和输出流:程序运行所在内存的角度来划分
    - 输入流:程序只能从中读取数据，而不能向其写入数据，例如：数据从硬盘到内存
    - 输出流:只能向其写入数据，而不能从中读取数据，例如：数据从内存到硬盘

2. 字节流和字符流:操作的数据单元来划分
    - 字节流操作8位的字节
    - 字符流操作16位的字符

3. 节点流和处理流:按流的角色划分
    - 底层节点流[低级流]:和底层物理存储节点直接关联,从/向一个特定IO设备[磁盘、网络]读/写数据的流，程序直接连接到实际的数据源[输入/输出节点]
    - 上层处理流[高级流||包装流]:用于对一个已存在的流进行连接或封装，通过封装后的流实现数据读写功能,不会直接连接实际的数据源，即没有和实际的输入/输出节点连接。

![输入输出流体系常用流分类][]

- 字节流功能比字符流强大，可以处理所有的二进制文件.
- 缓冲流则增加了缓冲功能，提高输入/输出效率，需要flush才可以将缓冲区内容写入实际的物理节点
- 对象流用于实现对象的序列化。
- 具有访问音频、加密/解密、压缩/解压等功能的字节流:AudioInputStream|CipherInputStream|DeflaterInputStream|ZipInputStream 等

# 15.2.3 常用输入/输出流
InputStream/Reader/OutputStream/Writer:是所有输入/输出流的抽象基类，不能创建实例,提供了read/write方法

==注意==:使用输出流后应该关闭，除了能够保证流的物理资源被系统回收之外，还可以将输出流缓冲区中的数据flush到物理节点里[因为执行close方法之前会自动执行flush()]

规则:
- 文本内容使用字符流，二进制内容使用字节流
- 字符流通常包装成字符输入缓冲流BufferedReader/字符打印输出流PrintWriter
- 字节流通常包装成字节输入缓冲流BufferedInputStream/字节打印输出流PrintStream
- 字符流需要指定字符集时：字节流->字符转换流InputStreamReader->缓冲流->[打印流]

## 节点流
- FileInputStream/FileOutputStream:用于读写二进制文件的字节输入/输出流，节点流，直接和指定文件关联
- FileReader/FileWriter:用于读写文本文件的字符输入/输出流，节点流，直接和指定文件关联
- StringReader/StringWriter:用于读写字符串的字符串输入/输出流，节点流，以字符串为物理节点

## 处理流
- 处理流:隐藏底层设备上节点流的差异，对外提供更加方便的输入/输出方法，程序员只需关心高级流的操作
- 思路:使用处理流包装节点流，程序通过处理流来执行输入/输出功能，让节点流与底层IO设备、文件交互
- 处理流的构造器参数是其他流[而非物理节点]，节点流则直接以物理存储节点作为构造器参数
- 使用处理流后，只需要关闭该处理流即可，系统会自动关闭该处理流包装的节点流。
    - 打印流:PrintStream,PrintWriter
    - 转换流:InputStreamReader/OutputStreamWriter
    - 缓冲流:BufferedInputStream/BufferedOutputStream,BufferedReader/BufferedWriter
    - 推回输入流:PushbackInputStream/PushbackReader:
        - 带有推回缓冲区，当程序调用unread()方法将数据推回缓冲区时，系统将会把指定数组的内容推回该缓冲区，从而允许重复读取刚刚读取的内容
        - 当输入流每次调用read方法时，总是先从推回缓冲区读取，只有完全读取了推回缓冲区的内容后，但还没有装满read所需数组时才会从原输入流中读取
        - 当创建该流时需要指定推回缓冲区的大小，默认长度为1。推回内容超出缓冲区长度将引发异常。
        ![推回输入流的处理示意图][]
        ```java
        package org.jwz.test;

        import java.io.FileInputStream;
        import java.io.IOException;
        import java.io.PushbackInputStream;
        
        /**
         * 推回输入流
         * 输出目标字符串前一次读取的内容
         * Created by 龍惊羽 on 2017/3/20.
         */
        public class PushBackTest {
            public static void main(String args[]) {
                try (
                        // 推回输入流
                        PushbackInputStream pis = new PushbackInputStream(new FileInputStream("pushback.txt"), 64)
                ) {
                    // 记录上一次读取的内容
                    String lastLine = "";
        
                    // 缓冲数组
                    byte[] buff = new byte[32];
                    // 实际读取的字节
                    int hasRead;
                    while ((hasRead = pis.read(buff)) > 0) {
                        // 本次读取的内容
                        String line = new String(buff, 0, hasRead);
                        // 将上次与本次的字符串连接起来
                        String tempLine = lastLine + line;
        
                        int targetIndex;
                        // 如果tempLine包含目标字符串，获取其索引
                        if ((targetIndex = tempLine.indexOf("testStr")) > 0) {
                            // 将两次读取的内容推回缓冲区
                            pis.unread(tempLine.getBytes());
                            // 重置缓冲数组长度
                            buff=new byte[targetIndex];
                            // 读取缓冲区数据到缓冲数组
                            pis.read(buff, 0, targetIndex);
                            System.out.println(new String(buff));
                            break;
                        }
                        // 若不包含target则上次字符串设置为本次字符串
                        lastLine = new String(buff, 0, hasRead);
                    }
                } catch (IOException ioe) {
                    System.out.println("IO异常");
                    ioe.printStackTrace();
                }
            }
        }
        ```

## 重定向标准输入/输出流
标准流
- 标准输入流 System.out:输出到屏幕
- 标准输出流 System.in:从键盘读取输入
- 标准错误流 System.err:输出到屏幕

重定向标准流
- setOut(PrintStream ps)
- setIn(InputStream in)
- setErr(PrintStream ps)

## JVM读写其他进程的数据
Runtime 对象的exec()方法可以运行平台上的其他程序，该方法产生一个 Process 对象，Process 对象代表由该 Java 程序启动的子进程。

Process 类提供三个方法用于让程序和其子进程通信
- InputStream getErrorStream():获取子进程的错误流
- InputStream getInputStream():获取子进程的输入流
- OutputStream getOutputStream():获取子进程的输出流

```java
package org.jwz.test;

import java.io.FileOutputStream;
import java.io.IOException;
import java.io.PrintStream;
import java.util.Scanner;

/**
 * 程序和子进程进行通信
 * 主程序
 * Created by 龍惊羽 on 2017/3/20.
 */
public class MainProcess {
    public static void main(String args[]) throws IOException {
        // 运行子进程
        Process p = Runtime.getRuntime().exec("java org.jwz.test.SubProcess");
        try (
                // 获取子进程的输入流，对于主程序是输出流
                PrintStream ps = new PrintStream(p.getOutputStream())
        ) {
            // 重定向标准输出：屏幕->子进程
            System.setOut(ps);
            // 向子进程写入数据
            System.out.println("这是发送给子进程的数据");
        }
    }
}

/**
 * 子进程程序
 */
class SubProcess {
    public static void main(String args[]) throws IOException {
        try (
                // 包装标准输入流
                Scanner sc = new Scanner(System.in);
                PrintStream ps = new PrintStream(new FileOutputStream("process.txt"))
        ) {
            // 获取主程序输入的数据
            while (sc.hasNext()) {
                ps.println("接收到主程序的数据:" + sc.next());
            }
        } catch (IOException ioe) {
            ioe.printStackTrace();
        }
    }
}
```

[处理流的模型图]:http://note.youdao.com/yws/public/resource/19cc8a2d6058bd78bb4dc157fb70ad26/xmlnote/538F58209A534D829842B96F11501AE9/3420 "处理流的模型图"
[输入输出流体系常用流分类]:http://note.youdao.com/yws/public/resource/19cc8a2d6058bd78bb4dc157fb70ad26/xmlnote/C8E5E4CFEE794A888EEC3B8A72754D4A/3423 "输入输出流体系常用流分类"
[推回输入流的处理示意图]:http://note.youdao.com/yws/public/resource/19cc8a2d6058bd78bb4dc157fb70ad26/xmlnote/D1A33C4C4A164D1FB4EF52615BAFDD82/3430 "推回输入流的处理示意图"